# Kolibri OS Overview / Обзор Kolibri OS / Kolibri OS 概览

**Copyright (c) 2025 Кочуров Владислав Евгеньевич**

---

## 1. Mission / Миссия / 使命

Обеспечить автономный запуск ядра Kolibri на минимальном оборудовании без зависимости от полноценных ОС.

---

## 2. Boot Sequence / Последовательность загрузки / 启动流程

1. BIOS запускает GRUB2, который находит запись меню Kolibri OS.
2. GRUB загружает `boot/kolibri.bin`, содержащий Multiboot2-заголовок и стартовую процедуру `kolibri_boot_entry`.
3. Ассемблерный код настраивает стек и передаёт `multiboot_magic` и `multiboot_info` в `kolibri_kernel_main`.
4. C-ядро инициализирует GDT, IDT, PIC, PIT и клавиатурный контроллер, после чего включает прерывания и переходит в режим ожидания.

---

## 3. CPU & Interrupt Init / Инициализация CPU и прерываний / CPU 与中断初始化

- GDT состоит из нулевого дескриптора, плоского кода и плоского данного сегмента. Настройка выполняется функцией `nastroit_gdt`, после чего селекторы перезагружаются через `lgdt` и дальний прыжок.
- IDT содержит 256 записей; обработчики таймера (IRQ0) и клавиатуры (IRQ1) подключаются к вектору 32 и 33. Заглушки реализованы в `kernel/interrupts.asm`, а логика обслуживания — в `kernel/main.c`.
- Контроллеры PIC переназначаются на диапазон 32–47, после чего функция `nastroit_pic` восстанавливает маски прерываний.
- PIT программируется на частоту 100 Гц. Каждые 100 тиков ядро выводит сообщение `[TICK]` в VGA-консоль.
- Обработчик клавиатуры читает скан-код PS/2, печатает его в «чистой» шестнадцатеричной форме и отправляет EOI в PIC.
- Весь вывод и логирование выполняется через прямую запись в VGA-буфер 0xB8000, что позволяет отслеживать состояние ядра без дополнительных драйверов.

## 4. Memory Map / Карта памяти / 内存布局

| Address | Description |
|---------|-------------|
| 0x0000:7C00 | Бут-сектор `kolibri.asm` |
| 0x0000:8000 | Таблица параметров (seed, node id) |
| 0x0010:0000 | Загружаемый бинарник `kolibri.bin` |
| 0x0020:0000 | Рабочая область ядра / стеки |

---

## 5. Configuration Block / Конфигурационный блок / 配置块

```
struct KolibriBootConfig {
    uint32_t seed;
    uint32_t node_id;
    uint16_t listen_port;
    uint16_t reserved;
};
```

Загрузчик заполняет структуру и передаёт адрес в регистре `SI` ядру.

---

## 6. Console Interface / Консольный интерфейс / 控制台接口

- Поддерживает команды REPL, аналогичные десктопной версии.
- Использует BIOS interrupt 0x10 для ввода/вывода.
- Буфер команд ограничен 128 символами; истории нет.

---

## 7. Build & Emulation / Сборка и эмуляция / 构建与仿真

1. Убедитесь, что установлены `nasm`, `i686-elf-gcc`, `i686-elf-ld` и `grub-mkrescue`.
2. Выполните `make iso` или напрямую `./scripts/build_iso.sh`. Скрипт соберёт микроядро и сформирует структуру `build/iso`.
3. Полученный образ `build/kolibri.iso` можно загрузить через `qemu-system-i386 -cdrom build/kolibri.iso` или записать на USB-носитель.

---

## 8. Roadmap / Дорожная карта / 路线图

- [ ] Автоматическая упаковка бинарника и загрузчика в `kolibri.sh`.
- [ ] Сетевой драйвер с поддержкой SLIP/UDP для обмена формулами прямо из Kolibri OS.
- [ ] Минимальный файловый слой для хранения `genome.dat` на RAM-диске.
- [ ] Интеграция с визуальным монитором через последовательный порт.

