# Formula Evolution Handbook / Руководство по эволюции формул / 公式进化手册

**Copyright (c) 2025 Кочуров Владислав Евгеньевич**

---

## 1. Concept / Концепция / 概念

- Формула представляется парой коэффициентов `(a, b)` и фитнесом.
- Пул содержит до 16 активных формул, которые мутируют и соревнуются.
- Fitness измеряет соответствие задачам; более успешные формулы доминируют.

---

## 2. Data Structures / Структуры данных / 数据结构

```c
typedef struct {
    int a;
    int b;
    double fitness;
} KolibriFormula;

typedef struct {
    KolibriFormula formulas[16];
    size_t count;
    KolibriRng rng;
} KolibriFormulaPool;
```

---

## 3. Lifecycle / Жизненный цикл / 生命周期

1. **Инициализация:** `kf_pool_init(pool, seed)` заполняет пул случайными формулами (`a` и `b` в пределах -9..9).
2. **Tick:** `kf_pool_tick(pool, inputs, targets, len)`
   - Оценивает существующие формулы на наборе примеров.
   - Обновляет fitness средним относительным отклонением.
   - Выполняет мутации: лучшие формулы остаются, худшие заменяются вариациями лучших.
3. **Выбор лучшей:** `kf_pool_best` возвращает указатель на формулу с максимальным fitness.
4. **Применение:** `kf_formula_apply(formula, x)` вычисляет `a * x + b`.

---

## 4. Fitness Function / Функция приспособленности / 适应度函数

- Используется обратная средняя абсолютная ошибка:
  \[
  fitness = 1.0 / (1.0 + \frac{1}{n} \sum |f(x_i) - y_i|)
  \]
- Значение в диапазоне `(0, 1]`. Чем ближе к 1, тем лучше.

---

## 5. Mutation Strategy / Стратегия мутаций / 变异策略

- С вероятностью 0.5 изменяется коэффициент `a` на `-1, 0 или 1`.
- Коэффициент `b` мутирует аналогичным образом.
- Новые значения ограничиваются диапазоном `[-128, 128]` для предотвращения переполнений.

---

## 6. Integration with Genome / Интеграция с геномом / 与基因组集成

- Каждая формула, достигшая порога fitness > 0.75, логируется в Kolibri Chain.
- Событие записывается как `event_type="FORMULA_EVOLVED"`, payload содержит `a`, `b`, fitness.

---

## 7. Manual Feedback / Ручная обратная связь / 人工反馈

- Команды REPL `:good` и `:bad` масштабируют fitness лучшей формулы, ускоряя обучение.
- `:why` возвращает параметры текущей формулы и источник данных.

---

## 8. Extending the Model / Расширение модели / 模型扩展

- Добавление новых операторов (например, квадратичные члены) требует изменения `KolibriFormula` и сериализации.
- Property-тесты должны проверять, что мутации не выходят за допустимый диапазон и fitness остаётся конечным.

