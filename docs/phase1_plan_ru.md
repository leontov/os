# Фаза 1: Кристаллическое ядро «Колибри»

## 1. Цели и критерии успеха
- Детально реализовать один узел роя с детерминированным поведением.
- Обеспечить обучение элементарной арифметике и логике через механизмы формул.
- Воплотить команды `:teach`, `:why`, `:canvas`, `:sync`, `:verify` в рамках одного процесса.
- Гарантировать неизменяемость и воспроизводимость `genome.dat` посредством хэш-цепочки HMAC-SHA256.

## 2. Архитектурные принципы
- **Десятичное мышление:** внутренние структуры данных ядра на C11 представлены как массивы `uint8_t` со значениями `0..9`. Строковые протоколы обрабатываются лишь как поток внешних символов, немедленно транскодируемых в десятичные последовательности.
- **Геном формул:** каждая единица знания — это короткая программа с фиксированным числом инструкций. Формулы кодируются в виде блоков из десятичных цифр, которые интерпретируются виртуальной машиной ядра. Формат: `[метка][операнды][контрольная сумма]`.
- **Движок эволюции:** ядро поддерживает поколенческую эволюцию формул: генерацию (мутация/скрещивание), оценку (фитнес-функция), селекцию (элитный пул). Все операции выполняются над десятичными массивами.
- **Временная летопись:** `genome.dat` — это журнал блоков рассуждений. Каждый блок содержит: длину, полезную нагрузку (формула или событие), отметку времени (в десятичном коде), HMAC предыдущего блока и собственную подпись. Журнал хранится в каталоге данных узла, не допускается перезапись или усечение.
- **Прозрачность:** все метаданные (метрики фитнеса, поток команд) отражаются через API логгера, выдающего десятичные трассы. Для визуализации `:canvas` формируются десятичные матрицы, которые UI преобразует в графику.

## 3. Основные компоненты ядра
1. **Модуль `digit_stream`** — отвечает за двустороннее преобразование между внешними байтовыми потоками и внутренними десятичными массивами. Предоставляет детерминированные фильтры нормализации ввода.
2. **Модуль `formula_vm`** — минималистичная стековая машина с поддержкой арифметики, логики и манипуляций над цифрами. Включает исполнение, проверку корректности и оценку фитнеса.
3. **Модуль `evolution_engine`** — организует циклы мутаций и селекции. Использует фиксированные наборы операторов мутации (точечная замена, инверсия, сплайс) и стратегию турнира для отбора.
4. **Модуль `genome_ledger`** — реализует ведение `genome.dat`. Обеспечивает генерацию HMAC, проверку целостности (`:verify`) и восстановление состояния (`:sync`).
5. **Интерфейс команд** — интерпретирует запросы пользователя, трансформирует их в десятичные последовательности и маршрутизирует к соответствующим модулям. Команда `:why` возвращает цепочку блоков, обосновывающих вывод.

## 4. План работ по этапам
1. **Исследование существующей базы** (0.5 дня)
   - Проанализировать текущий C-код (`apps/kolibri_node.c`, `kernel/`, `core/`) на предмет пригодных компонентов.
   - Зафиксировать точки расширения и совместимость с WebAssembly.
2. **Спецификация десятичного формата** (1 день)
   - Определить словарь кодов операций и длины формул.
   - Описать структуру блоков `genome.dat` и полей HMAC.
   - Подготовить тестовые векторы для трансформаций и подписи.
3. **Реализация модулей** (3 дня)
   - `digit_stream`: функции преобразования, юнит-тесты на C.
   - `formula_vm`: стек, набор инструкций, обработка ошибок.
   - `evolution_engine`: циклы поколений, фитнес по целевым задачам.
   - `genome_ledger`: запись/чтение блоков, генерация HMAC, проверка.
4. **Интеграция командного интерфейса** (1 день)
   - Маппинг команд на внутренние модули, сериализация ответов.
   - Реализация `:teach`, `:why`, `:canvas`, `:sync`, `:verify` на основе цифровых структур.
5. **Детерминированность и тестирование** (1.5 дня)
   - Фиксировать seed генераторов мутаций.
   - Создать юнит- и интеграционные тесты: арифметика (`2+2=4`), логика (`привет` -> `здравствуй`), проверка журнала.
   - Подготовить скрипты автоматизации (CTest, pytest-обёртки, проверка `genome.dat`).
6. **Документация и визуализация** (0.5 дня)
   - Описать интерфейсы модулей и десятичные форматы.
   - Подготовить черновой протокол для фронтенда (`:canvas` данные).

## 5. Риски и меры контроля
- **Сложность десятичного формата:** упростить инструкции и обеспечить строгий автоматический анализ в тестах.
- **Производительность эволюции:** ограничить размер популяции и число поколений в первой версии, предусмотреть профилировочные крючки.
- **Целостность журнала:** использовать стандартную библиотеку OpenSSL/mbedTLS или встроенную реализацию HMAC. Добавить двойную проверку при старте (`:verify`).
- **Совместимость WASM:** избегать не поддерживаемых функций C11, держать память в пределах 1 МБ, использовать `-s STANDALONE_WASM` при сборке.

## 6. Критерии готовности к Фазе 2
- Все юнит-тесты и проверки проходят детерминированно.
- `genome.dat` воспроизводимо идентичен при повторных запусках с одинаковым seed.
- Команды `:teach`, `:why`, `:canvas`, `:sync`, `:verify` возвращают корректные десятичные ответы.
- Документация и трассировки отражают прозрачную работу модулей для дальнейшего расширения роя.
