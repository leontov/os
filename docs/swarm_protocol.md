# Kolibri Swarm Protocol / Протокол роя Kolibri / Kolibri 群体协议

**Copyright (c) 2025 Кочуров Владислав Евгеньевич**

---

## 1. Transport / Транспорт / 传输层

- UDP поверх IPv4.
- Каждый узел слушает один порт (по умолчанию задаётся `--listen`).
- Широковещательные HELLO пакеты (`255.255.255.255:порт`) поддерживают автоматическое обнаружение соседей.
- Все пакеты подписываются HMAC-SHA256 (ключ задаётся на стороне узла, в Kolibri Node используется `kolibri-secret-key`).

---

## 2. Frame Format / Формат кадра / 帧格式

```
+------------+----------------------+-------------------------------+
| Offset (B) | Field                | Description                   |
+------------+----------------------+-------------------------------+
| 0..3       | Magic                | ASCII "KSP1"                  |
| 4          | Version              | Текущая версия (1)            |
| 5          | Type                 | 1=HELLO, 2=MIGRATE_FORMULA    |
| 6..9       | Node ID (uint32 BE)  | Идентификатор отправителя     |
| 10..11     | Port (uint16 BE)     | UDP-порт отправителя          |
| 12..13     | Payload Len (uint16) | Длина полезной нагрузки       |
| 14..N      | Payload              | Данные сообщения              |
| N..N+31    | HMAC-SHA256          | Подпись заголовка + payload   |
+------------+----------------------+-------------------------------+
```

Полезная нагрузка зависит от типа сообщения. Подпись вычисляется как `HMAC_SHA256(key, header || payload)`.

---

## 3. Messages / Сообщения / 消息

### 3.1 HELLO (Type=1)

- Payload: отсутствует (длина = 0).
- Назначение: объявить присутствие в сегменте и сообщить порт источника.
- Пакеты HELLO рассылаются периодически (по умолчанию каждые 5 секунд) и могут отправляться вручную (`:cluster hello`).
- Реализация: `kolibri_roy_otpravit_privet`.

### 3.2 MIGRATE_FORMULA (Type=2)

- Payload:
  - `uint8 digits_len` — количество десятичных символов в гене.
  - `digits_len` байт — массив цифр `0-9`.
  - `double fitness` — значение пригодности в формате IEEE754 (передаётся как 64-битное число в сетевом порядке).
- Назначение: передать эволюционировавший ген соседям (одноадресно или широковещательно).
- Реализация: `kolibri_roy_otpravit_sluchajnomu`, `kolibri_roy_otpravit_vsem`.
- Узел-получатель восстанавливает ген, помещает его в пул формул и фиксирует событие `IMPORT` в цифровом геноме.

---

## 4. Lifecycle / Жизненный цикл / 生命周期

1. `kolibri_roy_zapustit` — инициализация UDP-сокета, включение `SO_BROADCAST`, запуск фонового потока приёма.
2. Поток использует `select` с таймаутом 1 секунда, чтобы:
   - принимать входящие пакеты, верифицировать HMAC и обновлять список соседей;
   - каждые `KOLIBRI_ROY_PRIVET_INTERVAL` секунд отправлять широковещательное HELLO;
   - очищать устаревших соседей (TTL = 30 секунд).
3. События складываются в неблокирующую очередь и извлекаются вызывающей стороной через `kolibri_roy_poluchit_sobytie`.
4. `kolibri_roy_ostanovit` — завершение потока и закрытие сокета.

---

## 5. Error Handling / Обработка ошибок / 错误处理

- Некорректный HMAC → пакет отбрасывается.
- Неверная версия протокола или неподдерживаемый тип → пакет игнорируется.
- Слишком длинная полезная нагрузка → пакет отбрасывается без уведомления.
- Отправитель с истёкшим TTL удаляется из таблицы соседей.

---

## 6. Extending the Protocol / Расширение протокола / 协议扩展

1. Добавьте новый идентификатор типа (см. `KOLIBRI_ROY_TYP_*` в `backend/src/roy.c`).
2. Опишите новую полезную нагрузку в этом документе и в `docs/PROTOCOL.md`.
3. Расширьте обработку в `kolibri_roy_potok`, добавьте новые события или колбэки.
4. Создайте модульные тесты (`tests/test_roy.c`) и, при необходимости, сценарии в `scripts/run_cluster.sh`.

---

## 7. Swarm Orchestration / Оркестрация роя / 群体编排

- `scripts/run_cluster.sh` собирает проект, создаёт каталог `build/cluster` и запускает выбранное количество узлов.
- Каждый узел хранит цифровой геном (`genome_<id>.dat`) и журнал (`node_<id>.log`).
- Обнаружение соседей происходит автоматически через широковещательные HELLO. Опция `--peer` добавляет статический адрес, которому сразу отправляется приветствие.
- Параметр `-d` задаёт длительность эксперимента (0 — бессрочно). Остановка выполняется через `Ctrl+C`.

---

## 8. CLI Integration / Интеграция с CLI / 命令行集成

- `:sync` — отправляет лучший ген случайному соседу.
- `:cluster list` — выводит таблицу активных соседей.
- `:cluster broadcast` — рассылает ген всем соседям и в широковещательный канал.
- `:cluster hello` — принудительно отправляет HELLO.

