# WASM-ядро Kolibri в PWA

## Ограничение размера

- Допустимый размер артефакта `kolibri.wasm` ограничен 60 МБ (61440 КБ). Service Worker проверяет `Content-Length` при получении сообщения `SET_WASM_ARTIFACTS` и включает деградацию, если размер превышает лимит.
- В режиме деградации frontend получает уведомление и переключает UI в упрощённый режим (см. `DemoPage`).
- Порог может быть переопределён переменной `VITE_KOLIBRI_WASM_LIMIT_MB` во время сборки фронтенда.

## Метрики холодного старта

- Service Worker измеряет время от события `install` до момента готовности офлайн-кэша и передаёт результат в клиентов через сообщение `kolibri:pwa-metrics`.
- В React-приложении метрики запрашиваются при монтировании и показываются на демо-странице.
- Публикуемые поля: `coldStartMs`, `wasmBytes`, `offlineFallback`, `degradedReason`.

## Офлайн-кэш

- При активации Service Worker кэширует `index.html`, `kolibri.wasm`, `kolibri.wasm.txt`, `kolibri-knowledge.json` и ассеты `assets/**`.
- Кэш обновляется в фоне и защищён от устаревания через контроль версий `CACHE_NAME`.
- При ошибках загрузки knowledge dataset происходит fallback на локальные документы и фиксируется событие `genome.cache`.

## Сценарии деградации

1. **Перегруз по размеру WASM** — ядро не кэшируется, фронтенд переводится в режим «только аналитика».
2. **Холодный старт > 5 секунд** — отображается предупреждение и предлагается включить офлайн-предзагрузку.
3. **Отсутствует knowledge bundle** — чат работает только с LLM, сервис фиксирует событие `knowledge.miss`.
4. **Нет SSO** — доступен демо-токен из `KOLIBRI_SSO_DEGRADED_TOKENS`, UI отображает статус `Degraded`.

## Автоматизация проверки

- Скрипт `scripts/run_all.sh` запускает `scripts/generate_demo_storyboards.sh`, который сохраняет описание сценариев деградации и их хэши в `logs/demo_videos/`.
- Для ручной проверки PWA нужно выполнить `npm run build && npm run preview`, затем открыть `/demo` и сверить отображаемые метрики.
