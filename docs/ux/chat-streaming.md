# UX-гайд: потоковые ответы Kolibri Chat

Этот документ фиксирует требования к пользовательскому опыту при потоковой генерации ответов Kolibri. Он дополняет существующие гайды и должен использоваться при разработке новых фич, связанных с потоковой выдачей.

## Каналы доставки

- **SSE (Server-Sent Events)** — основной транспорт для браузера (`POST /api/v1/infer/stream`).
  - Ответ имеет `Content-Type: text/event-stream` и использует события `token`, `done`, `error`.
  - Клиент обязан поддерживать повторное соединение и деградировать в офлайн-режим без потери ввода.
- **WebSocket** (`/ws/v1/infer`) — двусторонний адаптер для thick-клиентов и мобильных приложений.
  - Авторизация повторяет логику HTTP: заголовок `Authorization: Bearer <token>`.
  - Поток сообщений использует JSON-структуры: `{ "type": "token" | "done" | "error", ... }`.

## UX-принципы потоковой выдачи

1. **Мгновенная обратная связь.** После отправки сообщения пользователь сразу видит карточку ассистента со статусом «Колибри формирует ответ» и анимацией курсора.
2. **Плавное наращивание текста.** Новые токены добавляются без перерисовки списка. Автоскролл активен, пока пользователь находится внизу ленты.
3. **Адаптивный фолбэк.** При обрыве стрима:
   - Если часть текста получена, она остаётся на экране.
   - Если токены не поступили, отображается эвристический офлайн-ответ (см. `generateFallbackResponse`).
   - Статус беседы возвращается в `idle`, чтобы не блокировать следующее сообщение.
4. **Доступность.**
   - Элемент сообщения ассистента получает `aria-busy="true"` на время генерации и скрытое объявление «Колибри формирует ответ» на выбранном языке.
   - Лента (`role="log"`) сохраняет `aria-live="polite"`, чтобы экранные дикторы корректно озвучивали обновления.
5. **Энергосбережение.** Дополнительная анимация ограничена тонким индикатором без дорогих переходов, что соответствует концепции лёгких интерфейсов Kolibri.

## Поведение демо и предпросмотров

- Стартовый сценарий в демо-окружении должен демонстрировать потоковую карточку (например, за счёт заранее записанного ответа или подключения к тестовому SSE).
- Скриншоты/видео для маркетинга должны фиксировать этапы: ввод → появление статуса → постепенная отрисовка → финальный ответ.

## QA-чеклист перед релизом

- Проверить корректность стрима в браузерах Chromium/Firefox, а также при потере сети (аварийное закрытие SSE).
- Убедиться, что WebSocket-адаптер закрывает соединение при отсутствии прав `kolibri.infer`.
- Проверить, что индикатор печати пропадает и время в карточке обновляется после завершения ответа.
- Прогнать офлайн-режим: сообщение отправляется в очередь, потоковые индикаторы не появляются.

Соблюдение этих правил гарантирует, что потоковые ответы остаются последовательными с принципами Kolibri: лёгкостью интерфейса, точностью коммуникации и уважением к ресурсу пользователя.
